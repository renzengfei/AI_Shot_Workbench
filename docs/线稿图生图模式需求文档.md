# 线稿图生图模式需求文档

## 1. 背景与目标

在当前的"人工改写页面"（Step 3: Deconstruction Review）中，生图功能基于"首帧描述 + 角色参考图 + 生图设定"生成新图片。为提高生成图片的构图一致性，需要新增一种**线稿图辅助生图模式**：

1. **先提取原片首帧的线稿（Outline/Sketch）**
2. **再用线稿 + 角色参考图 + 提示词生成新图**

这种模式可以让 AI 更好地保持原片的构图与动作，同时允许角色/风格的自由替换。

---

## 2. 核心概念定义

| 术语 | 说明 |
|------|------|
| **线稿图 (Outline)** | 从原片首帧提取的结构化草图（边缘/轮廓），用于引导 AI 生图时保持构图一致 |
| **标准模式** | 现有的生图方式：首帧描述 + 角色参考图 + 生图设定 |
| **线稿模式** | 新增的生图方式：线稿图 + 首帧描述（剔除景别/视角）+ 角色参考图 + 生图设定 |
| **线稿提示词** | 用于调用线稿提取 API 的提示词，控制提取的风格和细节程度 |

---

## 3. 核心功能需求

### 3.1 生图设定弹窗整合

线稿模式配置分为两部分：

**生图设定弹窗（配置项）**：
*   **全局模式切换**：在弹窗顶部提供"标准模式"与"线稿模式"切换
*   **线稿提示词配置**：全局默认提示词编辑
*   模式状态需**持久化保存**（workspace 配置）

**镜头列表顶部工具栏（操作项）**：
*   **批量生成线稿**：一键为所有镜头生成线稿图（与导出按钮同一行，左上角）
*   **生成进度显示**：已生成 X/N 个镜头（线稿模式下显示）

### 3.2 线稿图生成功能

*   **数据源**：每个镜头的原片首帧图（`workspaces/{id}/assets/frames/frame_001_xxx.jpg`）
*   **生成方式**：
    *   **一键批量生成**：为全部镜头批量生成线稿图
    *   **逐个生成**：单个镜头卡片上点击生成
    *   **再次生成**：生成新线稿追加到列表，不覆盖已有
*   **存储位置**：`workspaces/{id}/assets/outlines/{shot_id}/outline_{timestamp}.png`
*   **线稿图列表管理**：
    *   每个镜头可有多张线稿图，以列表形式呈现
    *   支持**单选**：选中一张作为"激活"线稿，后续生图使用该线稿
    *   支持**删除**：可删除任意一张线稿图
    *   默认选中最新生成的线稿

### 3.3 线稿提示词配置

*   **全局配置**：在"生图设定"弹窗的线稿配置区编辑
    *   默认提示词示例：`"extract clean line art, black outlines on white background, no shading, anime style"`
*   **单镜头修改**：每个镜头卡片可在全局提示词基础上修改
    *   默认继承全局提示词内容
    *   用户可在此基础上调整（如针对特定镜头添加细节要求）
    *   若已修改，显示"已自定义"标记，支持"恢复全局"操作

### 3.4 线稿模式下的生图流程

当全局或单镜头处于"线稿模式"时，生图流程变为：

```
原片首帧 → [线稿提取API] → 线稿图
                               ↓
    线稿图 + 首帧描述(剔除景别/视角) + 角色参考图 + 生图设定 → [生图API] → 新图
```

**首帧描述处理**：
*   线稿模式也需要首帧描述，但需自动剔除第一行的 `[景别]` 和 `[视角]` 标签
*   **剔除格式**：正则匹配 `\[景别\][^\n\[]*` 和 `\[视角\][^\n\[]*`
*   **示例**：
    *   原文：`[景别]中景 [视角]平视\n[主体与形象]...`
    *   处理后：`[主体与形象]...`
*   原因：线稿图已包含构图信息，景别/视角由线稿图决定，无需重复描述

**提示词组装规则**：
*   线稿模式下，最终提示词需包含对参考图的明确指引：
    ```
    {首帧描述（剔除景别/视角）}
    
    角色【{角色名1}】的形象、服装、发型严格参考图{角色参考图1编号}。
    角色【{角色名2}】的形象、服装、发型严格参考图{角色参考图2编号}。
    ...
    画面的景别、人物姿势和动作严格参考图{线稿图编号}。
    
    {生图设定内容}
    ```
*   **参考图编号**：按 API 要求，通常为 `image1`、`image2` 等，需与实际传入的图片顺序对应
*   **角色名**：从首帧描述中自动解析 `【xxx】` 格式的角色名

*   若**未生成线稿图**，点击"生成图片"时应：
    *   提示用户"请先生成线稿图"
*   线稿图生成后，可在卡片中预览

### 3.5 单镜头模式覆盖

*   每个镜头卡片可**临时切换**为另一种模式
    *   全局为"线稿模式"时，单镜头可切换为"标准模式"
    *   全局为"标准模式"时，单镜头可切换为"线稿模式"
*   切换状态仅影响当前镜头，不改变全局设置
*   切换后需有明显的**视觉标记**（如图标/徽章）

---

## 4. 详细界面与交互设计

### 4.1 生图设定弹窗（配置项）

**设计原则**：生图设定弹窗只包含配置项，操作按钮放在镜头列表顶部。

**UI 设计**：

```
+----------------------------------------------------------------------+
|  生图设定                                                        [X] |
+----------------------------------------------------------------------+
|                                                                      |
|  ┌──────────────────────────────────────────────────────────────┐   |
|  │  🔀 生图模式                                                  │   |
|  │  ────────────────────────────────────────────────────────    │   |
|  │                                                              │   |
|  │  [  标准模式  ]  [  线稿模式 ✓ ]     ← 全局模式切换          │   |
|  │                                                              │   |
|  │  标准模式：首帧描述 + 角色参考图 + 生图设定                  │   |
|  │  线稿模式：线稿图 + 首帧描述* + 角色参考图 + 生图设定        │   |
|  │            (*自动剔除景别/视角)                              │   |
|  └──────────────────────────────────────────────────────────────┘   |
|                                                                      |
|  ┌──────────────────────────────────────────────────────────────┐   |
|  │  🎨 线稿提取设定（线稿模式专用）                              │   |
|  │  ────────────────────────────────────────────────────────    │   |
|  │  线稿提示词：                                                 │   |
|  │  ┌──────────────────────────────────────────────────────┐   │   |
|  │  │ extract clean line art, black outlines on white      │   │   |
|  │  │ background, no shading, preserve composition         │   │   |
|  │  └──────────────────────────────────────────────────────┘   │   |
|  │                                                              │   |
|  │  ⚠️ 线稿模式下，若镜头未生成线稿，点击生图时将自动生成       │   |
|  └──────────────────────────────────────────────────────────────┘   |
|                                                                      |
|  ────────────────────────────────────────────────────────────────   |
|  🖼️ 生图设定列表（标准模式 & 线稿模式通用）                        |
|                                                                      |
|  ○ 不使用生图设定                                                   |
|  ● [当前选中] 动漫风格 - 高饱和度色彩，细腻线条...                  |
|  ○ 写实风格 - 真实光影，电影质感...                                 |
|                                                                      |
|  ┌────────────────────────────────────────────────────────────┐     |
|  │ 新增设定                                                    │     |
|  │ [________________输入框________________]     [新增设定]     │     |
|  └────────────────────────────────────────────────────────────┘     |
+----------------------------------------------------------------------+
```

**交互说明**：

1. **生图模式切换**：
   - 顶部 Tab 切换，高亮当前模式
   - 切换后影响所有镜头卡片的默认生图行为

2. **线稿提取设定**区域（线稿模式专用）：
   - 仅在"线稿模式"激活时显示，标准模式下隐藏或折叠
   - 多行文本框编辑全局线稿提示词

3. **生图设定列表**：
   - 保持现有功能不变
   - 两种模式下均可使用

---

### 4.2 镜头列表顶部工具栏（操作项）

**位置**：镜头列表顶部左上角，与导出按钮同一行

**UI 设计**：

```
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  [🎨 批量生成线稿]  已生成: 8/14        ...(其他工具)...        [导出]  [生图设定]  [模型配置] |
|   ↑                      ↑                                                                     |
|  线稿模式下显示        进度指示器                                                            |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  镜头卡片列表...                                                                              |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
```

**交互说明**：

1. **批量生成线稿按钮**：
   - 仅在"线稿模式"激活时显示
   - 点击后为所有镜头批量生成线稿图
   - 生成中显示 loading 状态

2. **进度指示器**：
   - 显示 `已生成: X/N`
   - 线稿模式下始终可见
   - 全部完成时显示 ✓

---

### 4.3 镜头卡片 - 素材流切换与线稿管理

在现有的图片/视频素材流切换基础上，新增**线稿流**按钮，放在第一个位置。

**素材流切换按钮布局**：

```
┌─────────────────────────────────────────────────────────────┐
│  [✏️ 线稿 ▼]  [🖼️ 图片]  [🎬 视频]      ← 素材流切换按钮    │
│       ↑                                                     │
│   点击展开线稿列表面板                                       │
└─────────────────────────────────────────────────────────────┘
```

**线稿流按钮点击展开面板**：

```
┌─────────────────────────────────────────────────────────────┐
│  [✏️ 线稿 ▲]  [🖼️ 图片]  [🎬 视频]                          │
│  ┌─────────────────────────────────────┐                    │
│  │  线稿列表 (3)                  [🔄+] │  ← 生成新线稿     │
│  │  ┌─────┐ ┌─────┐ ┌─────┐            │                    │
│  │  │ #1  │ │ #2✓ │ │ #3  │            │  ← 缩略图列表     │
│  │  │     │ │ ●   │ │     │            │    ✓ = 当前激活   │
│  │  └─────┘ └─────┘ └─────┘            │                    │
│  │  [删除选中] [设为激活]              │                    │
│  └─────────────────────────────────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

**镜头卡片完整布局**：

```
镜头卡片
+------------------------------------------------------------------------+
|  [✏️ 线稿 ▼]  [🖼️ 图片]  [🎬 视频]     [标准模式 ✓]                    |
|                                                                        |
|  ┌────────────────────────────┐  ┌────────────────────────────┐       |
|  │       原片首帧             │  │       生成图预览           │       |
|  │  ┌──────────────────────┐  │  │  ┌──────────────────────┐  │       |
|  │  │                      │  │  │  │                      │  │       |
|  │  │      [首帧图]        │  │  │  │     [生成图]         │  │       |
|  │  │                      │  │  │  │                      │  │       |
|  │  └──────────────────────┘  │  │  └──────────────────────┘  │       |
|  │  激活线稿: #2 (共3张)      │  │  ◀ 1/5 ▶                   │       |
|  └────────────────────────────┘  └────────────────────────────┘       |
|                                                                        |
|  首帧描述: [...编辑区域...]                                            |
|  线稿提示词: [使用全局 ▼] 或 [自定义编辑...]                           |
|                                                                        |
+------------------------------------------------------------------------+
```

**线稿流交互说明**：

1. **按钮状态**：
   - 无线稿时显示：`[✏️ 线稿 (0)]`
   - 有线稿时显示：`[✏️ 线稿 (3) ▼]`，数字表示线稿数量
   - 点击按钮展开/收起线稿列表面板

2. **线稿列表面板**：
   - 以缩略图网格展示该镜头的所有线稿
   - 当前激活的线稿显示 ✓ 标记
   - `[🔄+]` 按钮：生成新线稿（追加到列表）
   - 支持单选某张线稿后删除或设为激活

3. **激活线稿显示**：
   - 原片首帧区域下方显示当前激活的线稿编号
   - 线稿模式生图时使用该激活线稿

4. **与模式切换的关系**：
   - `[标准模式 ✓]` / `[线稿模式 ✓]` 按钮仍保留在顶部
   - 线稿流按钮仅管理线稿列表，不直接切换生图模式

---

### 4.4 镜头卡片 - 模式切换徽章

当单个镜头的模式与全局不同时，需要明显标记：

```
┌──────────────────────────────────────────────────────┐
│  镜头 #3                           [🎨 线稿模式 ✓]  │  ← 徽章显示当前模式
│  ─────────────────────────────────────────────────   │
│  ...                                                 │
│                                                      │
│  当前模式与全局不同                    [恢复全局设置] │  ← 点击恢复为全局模式
└──────────────────────────────────────────────────────┘
```

**徽章样式**：
- **标准模式徽章**：灰色/默认色，图标 🖼️ 或 📷
- **线稿模式徽章**：蓝色/强调色，图标 🎨 或 ✏️

---

### 4.5 线稿图生成进度与状态

**批量生成时的全局进度条**：

```
+----------------------------------------------------------------------+
|  正在生成线稿图...                                                   |
|  [████████████░░░░░░░░░░░░░░░░░░] 8/14 完成                         |
|                                           [取消]                     |
+----------------------------------------------------------------------+
```

**单镜头生成状态**：

| 状态 | 显示 |
|------|------|
| 未生成 | `[生成线稿]` 按钮（Primary） |
| 生成中 | 加载动画 + "生成中..." |
| 已生成 | 线稿图预览 + `[重新生成]` 按钮 |
| 生成失败 | 错误提示 + `[重试]` 按钮 |

---

## 5. 数据结构设计

### 5.1 Workspace 配置扩展

在 `workspaces/{id}/project.json` 或新文件中存储：

```json
{
  "imageGeneration": {
    "globalMode": "outline",           // "standard" | "outline"
    "outlinePrompt": "extract clean line art...",
    "shotOverrides": {
      "3": { "mode": "standard" },     // 镜头 3 使用标准模式
      "7": { 
        "mode": "outline",
        "outlinePrompt": "custom prompt for shot 7"  // 自定义线稿提示词
      }
    }
  }
}
```

### 5.2 线稿图文件结构

```
workspaces/{id}/
├── assets/
│   ├── frames/
│   │   ├── frame_001_0.000s.jpg      # 原片首帧
│   │   ├── frame_002_1.900s.jpg
│   │   └── ...
│   └── outlines/                      # 新增：线稿图目录
│       ├── outline_001.png            # 镜头 1 的线稿图
│       ├── outline_002.png
│       ├── outline_001_prompt.txt     # 可选：记录使用的提示词
│       └── ...
```

### 5.3 API 请求参数扩展

**线稿生成 API**：

```json
POST /api/workspaces/{workspace}/generate-outline
{
  "shot_id": 1,
  "source_frame": "frame_001_0.000s.jpg",
  "prompt": "extract clean line art...",
  "provider_id": "optional-provider-id"
}
```

**生图 API（线稿模式）**：

```json
POST /api/workspaces/{workspace}/generate-image
{
  "shot_id": 1,
  "mode": "outline",                    // 新增字段
  "outline_image": "outline_001.png",   // 新增字段
  "character_refs": ["char_a.png"],
  "prompt": "...",
  "preset_id": "..."
}
```

---

## 6. 交互流程图

### 6.1 全局模式切换流程

```
用户点击 [生图模式: 标准 ▼]
           │
           ▼
    ┌─────────────────┐
    │  选择新模式      │
    │  ○ 标准模式     │
    │  ● 线稿模式     │
    └─────────────────┘
           │
           ▼
    更新全局状态 + 持久化
           │
           ▼
    所有镜头卡片 UI 更新
    （显示对应的模式控件）
```

### 6.2 线稿模式下的生图流程

```
用户点击 [生成图片]
           │
           ▼
    检查是否已有线稿图
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
  有线稿         无线稿
    │             │
    │             ▼
    │      自动生成线稿
    │      (显示进度)
    │             │
    └──────┬──────┘
           │
           ▼
    调用生图 API
    (线稿 + 角色参考 + 提示词)
           │
           ▼
    显示生成结果
```

---

## 7. UI 线框图 (Wireframe)

### 7.1 顶部工具栏

```
+--------------------------------------------------------------------------------------------------+
|                                                                                                  |
|  ┌────────────────┐   ┌─────────────────────┐   ┌──────────┐  ┌──────────┐  ┌──────────┐       |
|  │ 拆解文件: v1 ▼ │   │ 生图模式: [线稿▼]   │   │ 生图设定 │  │生视频设定│  │ 模型配置 │       |
|  └────────────────┘   │  ○ 标准模式         │   └──────────┘  └──────────┘  └──────────┘       |
|                       │  ● 线稿模式  ←当前  │                                                   |
|                       └─────────────────────┘                                                   |
|                                                                                                  |
+--------------------------------------------------------------------------------------------------+
```

### 7.2 镜头卡片（线稿模式下）

```
+---------------------------------------------------------------------------------------------------+
|  镜头 #1                                                                    [🎨 线稿模式]        |
+---------------------------------------------------------------------------------------------------+
|                                                                                                   |
|  ┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐          |
|  │      原片首帧/线稿       │  │     选中的生成图         │  │     首帧描述            │          |
|  │  ┌───────────────────┐  │  │  ┌───────────────────┐  │  │                         │          |
|  │  │                   │  │  │  │                   │  │  │  一只橙色猫咪坐在窗台   │          |
|  │  │   [Tab: 首帧]     │  │  │  │                   │  │  │  上，阳光透过玻璃照在   │          |
|  │  │        ↓          │  │  │  │   [生成的图片]    │  │  │  它身上...              │          |
|  │  │   ┌───────────┐   │  │  │  │                   │  │  │                         │          |
|  │  │   │   首帧    │   │  │  │  │                   │  │  │  ─────────────────────  │          |
|  │  │   │   图片    │   │  │  │  └───────────────────┘  │  │  线稿提示词:            │          |
|  │  │   └───────────┘   │  │  │                         │  │  [全局默认 ▼]           │          |
|  │  │                   │  │  │  #12 · 2/5              │  │  或 [自定义...]         │          |
|  │  │ [首帧] [线稿✓]    │  │  │  ◀ [选择] ▶             │  │                         │          |
|  │  └───────────────────┘  │  └─────────────────────────┘  └─────────────────────────┘          |
|  │                         │                                                                     |
|  │ [🔄 生成线稿] [♻ 重新]  │        [切换为标准模式]                                             |
|  └─────────────────────────┘                                                                     |
|                                                                                                   |
|  +--------------------------------------------------------------------------------------------------+
|  |                           横向素材流 (生成的图片/视频)                                           |
|  |  [图片]  [视频]    │ 素材1 │ 素材2 │ 素材3 │ 素材4 │ ... →                                      |
|  +--------------------------------------------------------------------------------------------------+
|                                                                                                   |
+---------------------------------------------------------------------------------------------------+
```

### 7.3 线稿图预览切换

```
原片首帧/线稿 预览区
+---------------------------+
|  [首帧] [线稿✓] [对比]   |  ← Tab 切换
|  ┌─────────────────────┐  |
|  │                     │  |
|  │   当前选中内容       │  |
|  │   (首帧/线稿/并排)  │  |
|  │                     │  |
|  └─────────────────────┘  |
|                           |
|  状态: ✅ 线稿已生成      |
|  [🔄 重新生成]            |
+---------------------------+
```

---

## 8. 边界情况与异常处理

| 场景 | 处理方式 |
|------|----------|
| 线稿生成失败 | 显示错误信息，提供重试按钮，可点击查看详细错误 |
| 线稿模式下未生成线稿就点击生图 | 弹出提示"需要先生成线稿"，或自动串行执行 |
| 批量生成线稿时部分失败 | 完成后显示统计（成功 X 个，失败 Y 个），支持重试失败项 |
| 原片首帧不存在 | 禁用线稿生成按钮，显示"首帧缺失" |
| 切换全局模式时已有单镜头覆盖 | 保留单镜头覆盖设置，仅更新未覆盖的镜头 |

---

## 9. 技术实现建议

### 9.1 前端组件变更

| 文件 | 变更内容 |
|------|----------|
| `Step3_DeconstructionReview.tsx` | 新增全局模式状态、线稿设定弹窗区域 |
| `ShotCard.tsx` | 新增线稿预览 Tab、模式切换徽章、线稿提示词输入 |
| `lib/services/outlineService.ts` | 新增：线稿生成 API 调用封装 |
| `types/deconstruction.ts` | 扩展 Shot 类型，增加线稿相关字段 |

### 9.2 后端 API 扩展

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/workspaces/{path}/generate-outline` | POST | 为指定镜头生成线稿图 |
| `/api/workspaces/{path}/generate-outline/batch` | POST | 批量生成线稿图 |
| `/api/workspaces/{path}/outlines` | GET | 获取已生成的线稿图列表 |
| `/api/workspaces/{path}/outlines/{shot_id}` | DELETE | 删除指定线稿图 |
| `/api/workspaces/{path}/image-gen-config` | GET/PUT | 读写生图模式配置 |

### 9.3 状态管理

```typescript
// 新增状态字段
interface ImageGenState {
  globalMode: 'standard' | 'outline';
  outlinePrompt: string;
  shotOverrides: Record<number, {
    mode?: 'standard' | 'outline';
    outlinePrompt?: string;
  }>;
  outlineStatuses: Record<number, 'none' | 'generating' | 'done' | 'error'>;
  outlineUrls: Record<number, string>;  // shot_id -> outline image URL
}
```

---

## 10. 优先级与里程碑建议

| 阶段 | 功能 | 优先级 |
|------|------|--------|
| P0 | 全局模式切换 UI | 高 |
| P0 | 单镜头线稿生成 | 高 |
| P0 | 线稿模式下生图 API 调用 | 高 |
| P1 | 批量线稿生成 | 中 |
| P1 | 单镜头模式覆盖 | 中 |
| P1 | 线稿预览 Tab 切换 | 中 |
| P2 | 线稿提示词单镜头自定义 | 低 |
| P2 | 线稿图与首帧叠加对比 | 低 |

---

## 11. 附录：现有生图流程参考

**当前标准模式流程**：

```
首帧描述 + 生图设定 + 角色参考图 → 生图 API → 新图
                                      ↓
                              存储到 generated/{shot_id}/
```

**新增线稿模式流程**：

```
原片首帧 → [线稿API] → 线稿图 (存储到 outlines/)
                          ↓
    线稿图 + 生图设定 + 角色参考图 → 生图 API (ControlNet/参考图模式) → 新图
                                      ↓
                              存储到 generated/{shot_id}/
```
