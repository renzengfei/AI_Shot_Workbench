# 云雾 API 视频生成功能迭代文档

## 1. 背景与目标

### 1.1 现状
- 已完成云雾 API 后端集成（`yunwu_video_service.py`）
- 支持 Lovart 自动化 / 云雾 API 双模式切换
- API 调用已验证可用

### 1.2 迭代目标

- **前端配置界面**：可视化配置 API Key、生成参数、每镜头视频数
- **并发支持**：连续点击提交多镜头任务，后台并发执行
- **进度显示**：实时展示生成进度、状态变化
- **用户体验优化**：单镜头即时提交、任务管理、结果预览

---

## 2. 功能需求

### 2.1 前端配置界面

#### 2.1.0 Step3 顶部按钮调整

**现有「供应商」按钮改名 + 新增「生视频配置」按钮**：

| 改动 | 说明 |
|------|------|
| 「供应商」→「生图供应商」 | 明确区分生图/生视频配置 |
| 新增「生视频配置」按钮 | 放在「生图供应商」按钮旁边 |
| 生视频配置弹窗 | 点击按钮打开，包含云雾 API 配置项 |

**UI 设计**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  人工改写                                                            │
│                                                                     │
│  [生图设定]  [⚙️ 生图供应商]  [🎬 生视频配置]  [复制批注] ...        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**生视频配置弹窗内容**：

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| API Key | 密码输入框 | - | 云雾平台 API Key |
| 默认模型 | 下拉选择 | `grok-video-3` | 视频生成模型 |
| 默认尺寸 | 下拉选择 | `1080P` | 720P / 1080P |
| 默认比例 | 下拉选择 | `9:16` | 9:16 / 16:9 / 1:1 |
| 每镜头视频数 | 滑块 | 3 | 1-5 |
| 并发数 | 滑块 | 3 | 1-5 |
| 轮询间隔 | 输入框 | 10s | 状态查询间隔 |

**代码位置**：
- `Step3_DeconstructionReview.tsx` 第 2864 行附近
- 新建 `VideoConfigModal.tsx` 组件

---

#### 2.1.1 视频生成模式切换（Step7）

```
位置：Step7_VideoGen 组件顶部
```

| 组件 | 说明 |
|------|------|
| 模式选择器 | Toggle 切换 Lovart / API 模式 |
| 状态指示 | 显示当前模式、API 连接状态 |
| 快捷配置入口 | 点击打开配置面板 |

**UI 设计**：
```
┌─────────────────────────────────────────────────────────────┐
│  视频生成                                                    │
│  ┌──────────────────┐  ┌──────────────────┐                │
│  │  🤖 Lovart 自动化  │  │  ☁️ 云雾 API     │  ← 模式切换    │
│  └──────────────────┘  └──────────────────┘                │
│  ● API 已连接  |  余额: ¥128.50  |  ⚙️ 配置                 │
└─────────────────────────────────────────────────────────────┘
```

#### 2.1.2 API 配置面板（Modal）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| API Key | 密码输入框 | - | 云雾平台 API Key |
| 默认模型 | 下拉选择 | `grok-video-3` | 视频生成模型 |
| 默认尺寸 | 下拉选择 | `1080P` | 720P / 1080P |
| 默认比例 | 下拉选择 | `9:16` | 9:16 / 16:9 / 1:1 |
| **每镜头视频数** | 滑块 | 3 | 1-5，每个镜头生成几条视频 |
| 并发数 | 滑块 | 3 | 1-5，最大同时执行任务数 |
| 轮询间隔 | 输入框 | 10s | 状态查询间隔 |

**UI 设计**：
```
┌─────────────────────────────────────────────────────────────┐
│  ☁️ 云雾 API 配置                                    [×]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  API Key                                                    │
│  ┌─────────────────────────────────────────────┐ [测试连接] │
│  │ sk-****************************x4KR         │            │
│  └─────────────────────────────────────────────┘            │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │ 模型            │  │ 尺寸            │                  │
│  │ grok-video-3 ▼  │  │ 1080P        ▼  │                  │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │ 比例            │  │ 每镜头视频数    │                  │
│  │ 9:16         ▼  │  │ ●●●○○  3       │                  │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │ 并发数          │  │ 轮询间隔        │                  │
│  │ ●●●○○  3       │  │ 10 秒           │                  │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
│                              [取消]  [保存配置]             │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.2 单镜头提交与并发执行

#### 2.2.1 交互模式

**无批量按钮，支持连续点击提交**：
- 每个镜头卡片有独立的「生成视频」按钮
- 用户可连续点击多个镜头的生成按钮
- 每次点击立即提交任务到后台队列
- 后台按并发数限制自动调度执行

**每镜头生成多条视频**：
- 配置项：每镜头视频数（1-5）
- 点击一次生成按钮 → 提交 N 个视频任务
- 同一镜头的 N 个任务共享相同的图片和提示词
- 生成完成后展示 N 个视频供选择

**UI 交互流程**：
```
用户操作                           后台状态
──────────                         ──────────
点击 Shot 1.0 [生成]  ──────────▶  队列: [1.0-v1, 1.0-v2, 1.0-v3]
点击 Shot 2.0 [生成]  ──────────▶  队列: [..., 2.0-v1, 2.0-v2, 2.0-v3]
点击 Shot 3.0 [生成]  ──────────▶  队列: [..., 3.0-v1, 3.0-v2, 3.0-v3]
                                   
                                   执行池 (并发=3):
                                   [1.0-v1 ⏳] [1.0-v2 ⏳] [1.0-v3 ⏳]
                                   
                                   等待队列:
                                   [2.0-v1] [2.0-v2] [2.0-v3] ...
```

#### 2.2.2 并发执行策略
```python
# 并发控制参数
max_concurrent = 3       # 最大并发数
poll_interval = 10       # 轮询间隔（秒）
max_wait_per_task = 600  # 单任务超时（秒）
retry_on_fail = True     # 失败重试
max_retries = 2          # 最大重试次数
```

**任务队列管理**：
```
┌─────────────────────────────────────────────────────────────┐
│                     并发任务调度器                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   等待队列                 执行池 (max=3)                   │
│   ┌───────┐               ┌───────┐ ┌───────┐ ┌───────┐    │
│   │2.0-v1 │ ────────────▶ │1.0-v1 │ │1.0-v2 │ │1.0-v3 │    │
│   ├───────┤               │  ⏳   │ │  ⏳   │ │  ✓   │    │
│   │2.0-v2 │               │ 75%   │ │ 45%   │ │ done  │    │
│   ├───────┤               └───────┘ └───────┘ └───────┘    │
│   │2.0-v3 │                     │                          │
│   ├───────┤                     ▼                          │
│   │3.0-v1 │         ◀─── 完成后自动补充下一个任务           │
│   └───────┘                                                 │
│                                                             │
│   执行中: 3  |  队列中: 6  |  已完成: 1  |  预计: 8分钟     │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.3 进度显示

#### 2.3.1 任务卡片状态

每个镜头的视频生成卡片显示：

| 状态 | 图标 | 颜色 | 说明 |
|------|------|------|------|
| pending | ⏸️ | 灰色 | 等待执行 |
| queued | 🕐 | 蓝色 | 已加入队列 |
| processing | ⏳ | 橙色 | 生成中 |
| completed | ✅ | 绿色 | 已完成 |
| failed | ❌ | 红色 | 失败 |

**镜头卡片（支持多视频）**：
```
┌─────────────────────────────────────────────────────────────┐
│  Shot 1.0                                        [生成视频] │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐                                            │
│  │             │  prompt: camera slowly zooms in...         │
│  │   [参考图]   │                                            │
│  │             │  视频生成状态 (3/3):                        │
│  └─────────────┘                                            │
│                                                             │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                     │
│  │ v1 ⏳   │  │ v2 ⏳   │  │ v3 ✅   │                     │
│  │  75%    │  │  45%    │  │ [播放]  │                     │
│  │ ████░░  │  │ ███░░░  │  │         │                     │
│  └─────────┘  └─────────┘  └─────────┘                     │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3.2 顶部状态栏

在 Step7 顶部显示全局任务状态：

```
┌─────────────────────────────────────────────────────────────┐
│  ☁️ 云雾 API  |  ● 已连接                                    │
│                                                             │
│  执行中: 3  |  队列: 6  |  完成: 4  |  失败: 0              │
│  ████████████████░░░░░░░░░░░░░░░░  42%    [全部停止]       │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3.3 实时日志

```
┌─────────────────────────────────────────────────────────────┐
│  📋 执行日志                                    [清空] [导出]│
├─────────────────────────────────────────────────────────────┤
│  13:15:23  [INFO]  任务 1.0 开始执行                        │
│  13:15:24  [INFO]  API 返回任务ID: grok:ff3e2b29-...        │
│  13:15:34  [INFO]  任务 1.0 进度: 25%                       │
│  13:15:44  [INFO]  任务 1.0 进度: 55%                       │
│  13:15:54  [INFO]  任务 1.0 进度: 90%                       │
│  13:16:04  [SUCCESS]  任务 1.0 完成，视频已下载              │
│  13:16:05  [INFO]  任务 1.1 开始执行                        │
│  ...                                                        │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.4 结果预览与管理

#### 2.4.1 视频预览
- 完成后自动显示视频缩略图
- 点击播放预览
- 支持下载到本地

#### 2.4.2 任务管理
- 重试失败任务
- 删除任务
- 导出任务列表

---

## 3. 技术实现

### 3.1 后端 API 扩展

#### 3.1.1 新增接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/yunwu/config` | GET/POST | 获取/保存配置 |
| `/api/yunwu/test-connection` | POST | 测试 API 连接 |
| `/api/yunwu/tasks/run-concurrent` | POST | 并发执行任务 |
| `/api/yunwu/progress` | GET (SSE) | 实时进度推送 |

#### 3.1.2 并发执行器

```python
# backend/services/yunwu_video_service.py

async def run_concurrent(
    self,
    task_ids: List[str],
    max_concurrent: int = 3,
    progress_callback: Callable = None
):
    """
    并发执行多个视频生成任务
    
    Args:
        task_ids: 任务ID列表
        max_concurrent: 最大并发数
        progress_callback: 进度回调函数
    """
    semaphore = asyncio.Semaphore(max_concurrent)
    
    async def run_with_semaphore(task_id):
        async with semaphore:
            task = self.get_task(task_id)
            if task:
                await self.process_task(task, progress_callback)
    
    await asyncio.gather(*[
        run_with_semaphore(tid) for tid in task_ids
    ])
```

#### 3.1.3 SSE 进度推送

```python
# backend/main.py

from sse_starlette.sse import EventSourceResponse

@app.get("/api/yunwu/progress")
async def yunwu_progress_stream(task_ids: str):
    """SSE 实时进度推送"""
    ids = task_ids.split(",")
    
    async def event_generator():
        while True:
            service = get_yunwu_video_service()
            progress_data = []
            all_done = True
            
            for tid in ids:
                task = service.get_task(tid)
                if task:
                    progress_data.append({
                        "task_id": tid,
                        "status": task.status,
                        "progress": task.api_response.get("progress", 0) if task.api_response else 0
                    })
                    if task.status in ["pending", "processing"]:
                        all_done = False
            
            yield {
                "event": "progress",
                "data": json.dumps(progress_data)
            }
            
            if all_done:
                yield {"event": "done", "data": "{}"}
                break
            
            await asyncio.sleep(3)
    
    return EventSourceResponse(event_generator())
```

### 3.2 前端实现

#### 3.2.1 状态管理 (Zustand)

```typescript
// lib/stores/videoGenStore.ts

interface VideoGenState {
  mode: 'lovart' | 'api';
  config: YunwuConfig;
  tasks: VideoTask[];
  isRunning: boolean;
  progress: Record<string, number>;
  
  // Actions
  setMode: (mode: 'lovart' | 'api') => void;
  saveConfig: (config: YunwuConfig) => Promise<void>;
  addTasks: (shots: Shot[]) => Promise<void>;
  runConcurrent: (taskIds: string[]) => Promise<void>;
  stopAll: () => Promise<void>;
}

interface YunwuConfig {
  apiKey: string;
  model: string;
  size: string;
  aspectRatio: string;
  maxConcurrent: number;
  pollInterval: number;
}
```

#### 3.2.2 进度订阅 Hook

```typescript
// hooks/useVideoProgress.ts

export function useVideoProgress(taskIds: string[]) {
  const [progress, setProgress] = useState<Record<string, TaskProgress>>({});
  
  useEffect(() => {
    if (taskIds.length === 0) return;
    
    const eventSource = new EventSource(
      `/api/yunwu/progress?task_ids=${taskIds.join(',')}`
    );
    
    eventSource.addEventListener('progress', (e) => {
      const data = JSON.parse(e.data);
      setProgress(prev => {
        const next = { ...prev };
        data.forEach((item: TaskProgress) => {
          next[item.task_id] = item;
        });
        return next;
      });
    });
    
    eventSource.addEventListener('done', () => {
      eventSource.close();
    });
    
    return () => eventSource.close();
  }, [taskIds]);
  
  return progress;
}
```

#### 3.2.3 组件结构

```
Step7_VideoGen/
├── VideoGenHeader.tsx        # 模式切换、配置入口
├── ConfigModal.tsx           # API 配置弹窗
├── TaskGrid.tsx              # 任务卡片网格
├── TaskCard.tsx              # 单个任务卡片
├── ProgressPanel.tsx         # 总体进度面板
├── LogPanel.tsx              # 执行日志
└── VideoPreview.tsx          # 视频预览
```

---

## 4. 数据流

```
┌──────────────────────────────────────────────────────────────┐
│                        用户操作                               │
│  1. 配置 API  →  2. 选择镜头  →  3. 开始生成  →  4. 查看结果 │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                      前端 (React + Zustand)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ ConfigModal │  │  TaskGrid   │  │ProgressPanel│          │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘          │
│         │                │                │                  │
│         ▼                ▼                ▼                  │
│  ┌─────────────────────────────────────────────────┐        │
│  │              videoGenStore (Zustand)             │        │
│  └─────────────────────────────────────────────────┘        │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                      后端 (FastAPI)                           │
│  ┌─────────────────────────────────────────────────┐        │
│  │            /api/yunwu/* 路由                      │        │
│  └─────────────────────────────────────────────────┘        │
│                              │                               │
│                              ▼                               │
│  ┌─────────────────────────────────────────────────┐        │
│  │          YunwuVideoService                       │        │
│  │  - 任务管理  - 并发执行  - 进度追踪              │        │
│  └─────────────────────────────────────────────────┘        │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                    云雾 API (yunwu.ai)                        │
│  POST /v1/video/create  ←→  GET /v1/video/query              │
└──────────────────────────────────────────────────────────────┘
```

---

## 5. 实现计划

### Phase 1: 后端增强 (1天)
- [ ] 添加配置管理 API（保存/读取 API Key 和默认参数）
- [ ] 实现并发任务执行器
- [ ] 添加 SSE 进度推送端点
- [ ] 添加连接测试 API

### Phase 2: 前端基础 (1天)
- [ ] 创建 `videoGenStore` 状态管理
- [ ] 实现模式切换 UI
- [ ] 实现 API 配置弹窗
- [ ] 集成配置保存

### Phase 3: 任务管理 (1天)
- [ ] 实现任务卡片组件
- [ ] 从 Step6 获取图片列表
- [ ] 批量添加任务
- [ ] 任务状态显示

### Phase 4: 进度与并发 (1天)
- [ ] 实现 SSE 进度订阅
- [ ] 进度条动画
- [ ] 并发执行控制
- [ ] 执行日志面板

### Phase 5: 结果预览 (0.5天)
- [ ] 视频预览组件
- [ ] 下载功能
- [ ] 失败重试

### Phase 6: 测试与优化 (0.5天)
- [ ] 端到端测试
- [ ] 错误处理优化
- [ ] 性能调优

---

## 6. API 参考

### 6.1 云雾 API

**创建视频任务**
```http
POST https://yunwu.ai/v1/video/create
Content-Type: application/json
Authorization: Bearer {API_KEY}

{
  "model": "grok-video-3",
  "prompt": "camera slowly zooms in",
  "aspect_ratio": "9:16",
  "size": "1080P",
  "images": ["data:image/png;base64,..."]
}
```

**查询任务状态**
```http
GET https://yunwu.ai/v1/video/query?id={task_id}
Authorization: Bearer {API_KEY}
```

**响应示例**
```json
{
  "id": "grok:ff3e2b29-...",
  "status": "completed",
  "progress": 100,
  "video_url": "https://...",
  "thumbnail_url": "https://..."
}
```

### 6.2 返回尺寸说明

| 请求 size | 实际输出 | 说明 |
|-----------|----------|------|
| 720P | ~480×848 | 低分辨率 |
| 1080P | ~832×1504 | 高分辨率（推荐） |

> 注意：实际尺寸会根据输入图片比例自动调整

---

## 7. 风险与注意事项

1. **API 限流**：云雾 API 可能有并发限制，需要控制请求频率
2. **大文件上传**：图片 base64 可能超过 10MB，注意超时设置
3. **长时间任务**：单个视频生成可能需要 1-2 分钟，需要友好的等待提示
4. **费用监控**：建议添加余额查询和消费提醒功能
